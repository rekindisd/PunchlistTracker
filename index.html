<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punchlist App</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    form input, form select, form textarea, form button {
      width: 100%;
      margin-bottom: 12px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    form button {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    table th, table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }
    table th {
      background: #4CAF50;
      color: white;
    }
    .evidence-link {
      color: #3498db;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Punchlist App</h1>

    <form id="punchlistForm">
      <input type="text" id="description" placeholder="Deskripsi" required />
      <input type="text" id="requester" placeholder="Requester" required />
      <input type="date" id="request_date" required />
      <input type="text" id="assigned_to" placeholder="Assigned To" required />
      <input type="file" id="evidence" accept="image/*" />

      <button type="submit">Tambah Punchlist</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Deskripsi</th>
          <th>Requester</th>
          <th>Tanggal Request</th>
          <th>Assigned To</th>
          <th>Status</th>
          <th>Evidence</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody id="punchlistTable"></tbody>
    </table>
  </div>

  <script>
    const SUPABASE_URL = "https://ahhmhdwukqfquwodeunc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoaG1oZHd1a3FmcXV3b2RldW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzQxODQsImV4cCI6MjA3MTE1MDE4NH0.PlBMneWa9STztSgb3VeqlTP6gBvFyW-wc43uFAQmtdA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("punchlistForm");
    const tableBody = document.getElementById("punchlistTable");

    // Ambil data awal
    async function loadPunchlists() {
      const { data, error } = await supabaseClient
        .from("punchlist")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Load error:", error.message);
        return;
      }

      tableBody.innerHTML = "";
      data.forEach(item => {
        const row = `<tr>
          <td>${item.id}</td>
          <td>${item.description}</td>
          <td>${item.requester}</td>
          <td>${item.request_date || ""}</td>
          <td>${item.assigned_to}</td>
          <td>${item.status}</td>
          <td>${item.evidence_url ? `<a class="evidence-link" href="${item.evidence_url}" target="_blank">Lihat</a>` : "-"}</td>
          <td>${item.created_at}</td>
        </tr>`;
        tableBody.innerHTML += row;
      });
    }

    // Submit form
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const description = document.getElementById("description").value;
      const requester = document.getElementById("requester").value;
      const request_date = document.getElementById("request_date").value;
      const assigned_to = document.getElementById("assigned_to").value;
      const file = document.getElementById("evidence").files[0];

      let evidenceUrl = null;

      if (file) {
        const filePath = `punchlist/${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabaseClient.storage
          .from("evidence")
          .upload(filePath, file);

        if (uploadError) {
          alert("Upload gagal: " + uploadError.message);
          return;
        }

        const { data: publicUrlData } = supabaseClient.storage
          .from("evidence")
          .getPublicUrl(filePath);

        evidenceUrl = publicUrlData.publicUrl;
      }

      const { error: insertError } = await supabaseClient
        .from("punchlist")
        .insert([{
          description,
          requester,
          request_date,
          assigned_to,
          status: "on process",
          evidence_url: evidenceUrl
        }]);

      if (insertError) {
        alert("Insert gagal: " + insertError.message);
        console.error(insertError);
        return;
      }

      form.reset();
      loadPunchlists();
    });

    loadPunchlists();
  </script>
</body>
</html>
