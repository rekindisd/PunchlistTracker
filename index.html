<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Punchlist Management</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #74ebd5, #ACB6E5);
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
    }
    h1 {
      margin-top: 20px;
      font-size: 28px;
      color: #fff;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.2);
    }
    .container {
      background: #fff;
      padding: 25px;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      width: 95%; max-width: 700px;
    }
    label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
      color: #333;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    button {
      background: #4CAF50;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    table {
      width: 100%;
      margin-top: 25px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #4CAF50;
      color: #fff;
    }
    .status-onprocess {
      color: orange; font-weight: bold;
    }
    .status-done {
      color: green; font-weight: bold;
    }
    .evidence-img {
      max-width: 100px; border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Punchlist Tracker</h1>

  <div class="container">
    <form id="punchlistForm">
      <label>Description</label>
      <textarea id="description" required></textarea>

      <label>Requested By</label>
      <input type="text" id="requested_by" required />

      <label>Request Date</label>
      <input type="date" id="request_date" required />

      <label>Assigned To</label>
      <input type="text" id="assigned_to" required />

      <label>Upload Evidence (Image)</label>
      <input type="file" id="evidence" accept="image/*" />

      <button type="submit">Submit</button>
    </form>

    <table id="punchlistTable">
      <thead>
        <tr>
          <th>Description</th>
          <th>Requested By</th>
          <th>Date</th>
          <th>Assigned To</th>
          <th>Status</th>
          <th>Evidence</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Ganti dengan config dari Supabase Project Settings
    const SUPABASE_URL = "https://ahhmhdwukqfquwodeunc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoaG1oZHd1a3FmcXV3b2RldW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzQxODQsImV4cCI6MjA3MTE1MDE4NH0.PlBMneWa9STztSgb3VeqlTP6gBvFyW-wc43uFAQmtdA";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById('punchlistForm');
    const tableBody = document.querySelector('#punchlistTable tbody');

    async function fetchPunchlist() {
      const { data, error } = await supabase.from("punchlist").select("*").order("id", { ascending: false });
      if (error) {
        console.error(error);
        return;
      }
      tableBody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.description}</td>
          <td>${row.requested_by}</td>
          <td>${row.request_date}</td>
          <td>${row.assigned_to}</td>
          <td class="${row.status === 'done' ? 'status-done' : 'status-onprocess'}">${row.status}</td>
          <td>${row.evidence_url ? `<img src="${row.evidence_url}" class="evidence-img"/>` : '-'}</td>
          <td>${row.status === 'on process' ? `<button onclick="markDone(${row.id})">Mark Done</button>` : ''}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function markDone(id) {
      const { error } = await supabase.from("punchlist").update({ status: "done" }).eq("id", id);
      if (error) console.error(error);
      fetchPunchlist();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const description = document.getElementById("description").value;
      const requested_by = document.getElementById("requested_by").value;
      const request_date = document.getElementById("request_date").value;
      const assigned_to = document.getElementById("assigned_to").value;
      const evidenceFile = document.getElementById("evidence").files[0];

      let evidence_url = null;

      // Upload image jika ada
      if (evidenceFile) {
        const fileName = Date.now() + "-" + evidenceFile.name;
        const { data: storageData, error: storageError } = await supabase
          .storage.from("evidence") // bucket harus ada
          .upload(fileName, evidenceFile);

        if (storageError) {
          console.error("Upload failed:", storageError.message);
        } else {
          evidence_url = `${SUPABASE_URL}/storage/v1/object/public/evidence/${fileName}`;
        }
      }

      const { error } = await supabase.from("punchlist").insert([{
        description,
        requested_by,
        request_date,
        assigned_to,
        status: "on process",
        evidence_url
      }]);

      if (error) {
        console.error(error);
      } else {
        form.reset();
        fetchPunchlist();
      }
    });

    fetchPunchlist();
  </script>
</body>
</html>
